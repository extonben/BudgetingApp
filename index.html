<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Personal Expense Tracker</title>
    <!-- Link to the PWA manifest file -->
    <link rel="manifest" href="manifest.json">
    <!-- Tailwind CSS CDN for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter font from Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        /* Custom scrollbar for table overflow */
        .overflow-x-auto::-webkit-scrollbar {
            height: 8px;
        }
        .overflow-x-auto::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        .overflow-x-auto::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }
        .overflow-x-auto::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        /* Modal backdrop styles */
        .modal-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 50;
        }
    </style>
</head>
<body>

    <div id="app" class="min-h-screen flex flex-col items-center justify-center p-2 sm:p-4 transition-colors duration-500">
        <!-- Login form and app content will be rendered here by JavaScript -->
    </div>

    <script>
        // All JavaScript logic for the application
        document.addEventListener('DOMContentLoaded', () => {

            // Register the service worker for PWA functionality
            if ('serviceWorker' in navigator) {
                window.addEventListener('load', () => {
                    navigator.serviceWorker.register('service-worker.js').then(registration => {
                        console.log('Service Worker registered with scope:', registration.scope);
                    }).catch(err => {
                        console.log('Service Worker registration failed:', err);
                    });
                });
            }

            const appContainer = document.getElementById('app');
            const CORRECT_PASSWORD = 'extonben'; // CHANGE PASSWORD!

            // --- State Management using local variables and localStorage ---
            let expenses = JSON.parse(localStorage.getItem('expenses')) || [];
            let currentView = 'form';
            let selectedMonthYear = '';
            let editingExpense = null;
            let currentDeleteId = null;

            // Define constants
            const categories = ['Food', 'Transport', 'Other essentials', 'Fun', 'Subscriptions', 'Capital expenditure'];
            const types = ['Personal', 'Joint'];

            // Define color palette for categories for the chart
            const categoryColors = {
                'Food': 'bg-blue-500',
                'Transport': 'bg-green-500',
                'Other essentials': 'bg-purple-500',
                'Fun': 'bg-red-500',
                'Subscriptions': 'bg-yellow-500',
                'Capital expenditure': 'bg-gray-500',
                'Uncategorised': 'bg-pink-500',
            };

            // --- UI Rendering Functions ---
            
            function renderLogin() {
                appContainer.className = "min-h-screen flex flex-col items-center justify-center p-2 sm:p-4 transition-colors duration-500 bg-gray-100";
                appContainer.innerHTML = `
                    <div class="p-4 sm:p-6 bg-white rounded-lg shadow-xl max-w-sm mx-auto my-4 sm:my-8 w-full">
                        <h2 class="text-xl sm:text-2xl font-bold text-gray-800 mb-4 sm:mb-6 text-center">Login</h2>
                        <form id="loginForm" class="space-y-4">
                            <div>
                                <label for="password" class="block text-sm font-medium text-gray-700">Enter Password</label>
                                <input type="password" id="password" required class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 text-sm">
                            </div>
                            <button type="submit" class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition duration-150 ease-in-out">
                                Login
                            </button>
                            <div id="loginMessage" class="mt-4 p-3 rounded-md text-sm hidden"></div>
                        </form>
                    </div>
                `;
                document.getElementById('loginForm').addEventListener('submit', handleLogin);
            }

            function render() {
                // Determine background color based on current month's total
                const { currentMonthTotal } = calculateMonthlyData(selectedMonthYear);
                const bgColor = getBackgroundColor(currentMonthTotal);
                appContainer.className = `min-h-screen flex flex-col items-center justify-center p-2 sm:p-4 transition-colors duration-500 ${bgColor}`;

                appContainer.innerHTML = `
                    <div class="w-full flex flex-col sm:flex-row justify-center space-y-3 sm:space-y-0 sm:space-x-4 mb-4 sm:mb-8 px-2">
                        <button id="viewFormBtn" class="py-2 px-4 sm:py-3 sm:px-6 rounded-lg text-base sm:text-lg font-semibold transition duration-300 ease-in-out ${currentView === 'form' ? 'bg-indigo-700 text-white shadow-lg' : 'bg-indigo-100 text-indigo-700 hover:bg-indigo-200'}">
                            Log Expense
                        </button>
                        <button id="viewBreakdownBtn" class="py-2 px-4 sm:py-3 sm:px-6 rounded-lg text-base sm:text-lg font-semibold transition duration-300 ease-in-out ${currentView === 'breakdown' ? 'bg-indigo-700 text-white shadow-lg' : 'bg-indigo-100 text-indigo-700 hover:bg-indigo-200'}">
                            View Breakdown
                        </button>
                    </div>
                    ${currentView === 'form' ? renderForm() : renderBreakdown()}
                    <!-- Custom delete confirmation modal -->
                    <div id="deleteModal" class="modal-backdrop hidden">
                        <div class="bg-white p-6 rounded-lg shadow-xl w-80 text-center">
                            <h3 class="text-lg font-bold text-gray-800 mb-4">Are you sure?</h3>
                            <p class="text-sm text-gray-600 mb-6">Do you really want to delete this expense? This action cannot be undone.</p>
                            <div class="flex justify-center space-x-4">
                                <button id="cancelDeleteBtn" class="py-2 px-4 rounded-md text-sm font-medium text-gray-700 bg-gray-100 hover:bg-gray-200">Cancel</button>
                                <button id="confirmDeleteBtn" class="py-2 px-4 rounded-md text-sm font-medium text-white bg-red-600 hover:bg-red-700">Delete</button>
                            </div>
                        </div>
                    </div>
                `;

                // Add event listeners after rendering
                document.getElementById('viewFormBtn').addEventListener('click', () => {
                    currentView = 'form';
                    editingExpense = null;
                    render();
                });
                document.getElementById('viewBreakdownBtn').addEventListener('click', () => {
                    currentView = 'breakdown';
                    render();
                });
                
                // Add modal event listeners
                document.getElementById('cancelDeleteBtn').addEventListener('click', hideDeleteModal);
                document.getElementById('confirmDeleteBtn').addEventListener('click', handleDeleteConfirmed);
            }

            function renderForm() {
                const isEditing = !!editingExpense;
                const formTitle = isEditing ? 'Edit Expense' : 'Log New Expense';
                const buttonText = isEditing ? 'Update Expense' : 'Enter Expense';
                const expenseDate = isEditing ? new Date(editingExpense.date).toISOString().split('T')[0] : new Date().toISOString().split('T')[0];
                const formMarkup = `
                    <div id="expense-form" class="p-4 sm:p-6 bg-white rounded-lg shadow-xl max-w-lg mx-auto my-4 sm:my-8 w-full">
                        <h2 class="text-xl sm:text-2xl font-bold text-gray-800 mb-4 sm:mb-6 text-center">${formTitle}</h2>
                        <form id="expenseForm" class="space-y-3 sm:space-y-4">
                            <div>
                                <label for="where" class="block text-sm font-medium text-gray-700">Where</label>
                                <input type="text" id="where" value="${isEditing ? editingExpense.where : ''}" required class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 text-sm" placeholder="e.g., Sainsbury's">
                            </div>
                            <div>
                                <label for="what" class="block text-sm font-medium text-gray-700">What</label>
                                <input type="text" id="what" value="${isEditing ? editingExpense.what : ''}" required class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 text-sm" placeholder="e.g., Groceries">
                            </div>
                            <div>
                                <label for="date" class="block text-sm font-medium text-gray-700">Date</label>
                                <input type="date" id="date" value="${expenseDate}" required class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 text-sm">
                            </div>
                            <div>
                                <label for="category" class="block text-sm font-medium text-gray-700">Category</label>
                                <select id="category" required class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 text-sm">
                                    <option value="" disabled selected>Select a Category</option>
                                    ${categories.map(cat => `<option value="${cat}" ${isEditing && editingExpense.category === cat ? 'selected' : ''}>${cat}</option>`).join('')}
                                </select>
                            </div>
                            <div>
                                <label for="type" class="block text-sm font-medium text-gray-700">Type</label>
                                <select id="type" required class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 text-sm">
                                    <option value="" disabled selected>Select a Type</option>
                                    ${types.map(typ => `<option value="${typ}" ${isEditing && editingExpense.type === typ ? 'selected' : ''}>${typ}</option>`).join('')}
                                </select>
                            </div>
                            <div>
                                <label for="cost" class="block text-sm font-medium text-gray-700">Cost (£)</label>
                                <input type="number" id="cost" value="${isEditing ? editingExpense.cost : ''}" required min="0.01" step="0.01" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 text-sm" placeholder="e.g., 25.50">
                            </div>
                            <button type="submit" class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition duration-150 ease-in-out">
                                ${buttonText}
                            </button>
                            ${isEditing ? `
                                <button type="button" id="cancelEditBtn" class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-indigo-700 bg-indigo-100 hover:bg-indigo-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 mt-2 transition duration-150 ease-in-out">
                                    Cancel Edit
                                </button>
                            ` : ''}
                            <div id="message" class="mt-4 p-3 rounded-md text-sm hidden"></div>
                        </form>
                    </div>
                `;
                setTimeout(() => {
                    const form = document.getElementById('expenseForm');
                    form.addEventListener('submit', handleFormSubmit);

                    const cancelEditBtn = document.getElementById('cancelEditBtn');
                    if (cancelEditBtn) {
                        cancelEditBtn.addEventListener('click', () => {
                            editingExpense = null;
                            render();
                        });
                    }
                }, 0);
                return formMarkup;
            }

            function renderBreakdown() {
                const { monthlyExpenses, currentMonthTotal, categoryBreakdown } = calculateMonthlyData(selectedMonthYear);
                const chartTotal = Object.values(categoryBreakdown).reduce((sum, val) => sum + val, 0);

                const tableRows = monthlyExpenses.length > 0 ? monthlyExpenses.map(expense => `
                    <tr class="hover:bg-gray-50">
                        <td class="px-3 py-2 sm:px-6 sm:py-4 whitespace-nowrap text-xs sm:text-sm text-gray-900">${new Date(expense.date).toLocaleDateString('en-GB')}</td>
                        <td class="px-3 py-2 sm:px-6 sm:py-4 whitespace-nowrap text-xs sm:text-sm text-gray-900">${expense.where}</td>
                        <td class="px-3 py-2 sm:px-6 sm:py-4 whitespace-nowrap text-xs sm:text-sm text-gray-900">${expense.what}</td>
                        <td class="px-3 py-2 sm:px-6 sm:py-4 whitespace-nowrap text-xs sm:text-sm text-gray-900">${expense.category}</td>
                        <td class="px-3 py-2 sm:px-6 sm:py-4 whitespace-nowrap text-xs sm:text-sm text-gray-900">${expense.type}</td>
                        <td class="px-3 py-2 sm:px-6 sm:py-4 whitespace-nowrap text-xs sm:text-sm text-gray-900">£${expense.cost.toFixed(2)}</td>
                        <td class="px-3 py-2 sm:px-6 sm:py-4 whitespace-nowrap text-right text-sm font-medium flex items-center">
                            <button class="edit-btn text-indigo-600 hover:text-indigo-900 mr-3 p-1 rounded-full hover:bg-gray-100" title="Edit expense" data-id="${expense.id}">
                                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-pencil">
                                    <path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"/>
                                    <path d="m15 5 4 4"/>
                                </svg>
                            </button>
                            <button class="delete-btn text-red-600 hover:text-red-900 p-1 rounded-full hover:bg-gray-100" title="Delete expense" data-id="${expense.id}">
                                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-trash-2">
                                    <path d="M3 6h18"/>
                                    <path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/>
                                    <path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/>
                                    <line x1="10" x2="10" y1="11" y2="17"/>
                                    <line x1="14" x2="14" y1="11" y2="17"/>
                                </svg>
                            </button>
                        </td>
                    </tr>
                `).join('') : `
                    <tr>
                        <td colspan="7" class="px-6 py-4 whitespace-nowrap text-sm text-gray-600 text-center">No expenses recorded for this month.</td>
                    </tr>
                `;

                const monthOptions = generateMonthOptions();
                const breakdownMarkup = `
                    <div id="monthly-breakdown" class="p-4 sm:p-6 bg-white rounded-lg shadow-xl max-w-3xl mx-auto my-4 sm:my-8 w-full">
                        <h2 class="text-xl sm:text-2xl font-bold text-gray-800 mb-4 sm:mb-6 text-center">Monthly Expense Breakdown</h2>
                        <div class="mb-6 flex flex-col sm:flex-row justify-center items-center space-y-3 sm:space-y-0 sm:space-x-3">
                            <label for="monthSelector" class="text-sm font-medium text-gray-700">Select Month:</label>
                            <select id="monthSelector" class="p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 text-sm">
                                ${monthOptions.map(option => `<option value="${option.value}" ${selectedMonthYear === option.value ? 'selected' : ''}>${option.label}</option>`).join('')}
                            </select>
                        </div>
                        <div class="p-4 rounded-md text-center mb-6 transition-colors duration-500">
                            <h3 class="text-lg sm:text-xl font-semibold text-gray-800">Total Budget Expenditure: £${currentMonthTotal.toFixed(2)}</h3>
                        </div>
                        <h3 class="text-lg sm:text-xl font-semibold text-gray-800 mb-4">Category Breakdown:</h3>
                        ${Object.keys(categoryBreakdown).length > 0 ? `
                            <div class="space-y-4">
                                <div class="w-full bg-gray-100 rounded-md p-3">
                                    ${Object.entries(categoryBreakdown).sort(([, aCost], [, bCost]) => bCost - aCost).map(([category, amount]) => {
                                        const percentage = chartTotal > 0 ? (amount / chartTotal) * 100 : 0;
                                        const barColor = categoryColors[category] || 'bg-gray-400';
                                        return `
                                            <div class="mb-2 last:mb-0">
                                                <div class="flex justify-between items-center text-sm text-gray-700 mb-1">
                                                    <span>${category}</span>
                                                    <span>£${amount.toFixed(2)} (${percentage.toFixed(1)}%)</span>
                                                </div>
                                                <div class="w-full bg-gray-200 rounded-full h-2">
                                                    <div class="${barColor} h-full rounded-full" style="width: ${percentage}%"></div>
                                                </div>
                                            </div>
                                        `;
                                    }).join('')}
                                </div>
                                <ul class="space-y-2">
                                    ${Object.entries(categoryBreakdown).map(([category, amount]) => `
                                        <li class="flex justify-between items-center bg-gray-50 p-3 rounded-md shadow-sm text-sm">
                                            <span class="font-medium text-gray-700">${category}</span>
                                            <span class="font-semibold text-indigo-700">£${amount.toFixed(2)}</span>
                                        </li>
                                    `).join('')}
                                </ul>
                            </div>
                        ` : `<p class="text-gray-600 text-center text-sm">No expenses recorded for this month (excluding Capital expenditure).</p>`}
                        ${monthlyExpenses.length > 0 ? `
                            <div class="mt-8">
                                <h3 class="text-lg sm:text-xl font-semibold text-gray-800 mb-4">Recent Expenses:</h3>
                                <div class="overflow-x-auto">
                                    <table class="min-w-full divide-y divide-gray-200">
                                        <thead class="bg-gray-50">
                                            <tr>
                                                <th class="px-3 py-2 sm:px-6 sm:py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider rounded-tl-md">Date</th>
                                                <th class="px-3 py-2 sm:px-6 sm:py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Where</th>
                                                <th class="px-3 py-2 sm:px-6 sm:py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">What</th>
                                                <th class="px-3 py-2 sm:px-6 sm:py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Category</th>
                                                <th class="px-3 py-2 sm:px-6 sm:py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Type</th>
                                                <th class="px-3 py-2 sm:px-6 sm:py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Cost</th>
                                                <th class="px-3 py-2 sm:px-6 sm:py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider rounded-tr-md">Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody class="bg-white divide-y divide-gray-200">
                                            ${tableRows}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        ` : ''}
                        <div class="mt-8 text-center">
                            <button id="downloadBtn" class="py-1 px-2 text-sm font-normal text-gray-500 hover:text-gray-700 hover:bg-gray-100 rounded-md transition duration-150 ease-in-out">
                                Download All Data (.csv)
                            </button>
                        </div>
                    </div>
                `;
                setTimeout(() => {
                    document.getElementById('monthSelector').addEventListener('change', (e) => {
                        selectedMonthYear = e.target.value;
                        render();
                    });
                    document.querySelectorAll('.edit-btn').forEach(btn => btn.addEventListener('click', handleEdit));
                    document.querySelectorAll('.delete-btn').forEach(btn => btn.addEventListener('click', handleDelete));
                    document.getElementById('downloadBtn').addEventListener('click', downloadAsCsv);
                }, 0);
                return breakdownMarkup;
            }

            // --- Business Logic Functions ---

            function saveExpenses() {
                localStorage.setItem('expenses', JSON.stringify(expenses));
            }

            function getBackgroundColor(total) {
                if (total > 400) return 'bg-red-200';
                if (total >= 300) return 'bg-orange-200';
                return 'bg-green-100';
            }

            function calculateMonthlyData(monthYear) {
                const monthlyExpenses = expenses
                    .filter(exp => exp.monthYear === monthYear)
                    .sort((a, b) => new Date(b.date) - new Date(a.date));

                let currentMonthTotal = 0;
                const categoryBreakdown = {};

                monthlyExpenses.forEach(exp => {
                    if (exp.category === 'Capital expenditure') return;

                    let costToAdd = parseFloat(exp.cost);
                    if (exp.type === 'Joint') costToAdd /= 2;
                    currentMonthTotal += costToAdd;
                    const category = exp.category || 'Uncategorised';
                    categoryBreakdown[category] = (categoryBreakdown[category] || 0) + costToAdd;
                });
                return { monthlyExpenses, currentMonthTotal, categoryBreakdown };
            }

            function generateMonthOptions() {
                const options = [];
                const today = new Date();
                for (let i = -12; i <= 12; i++) {
                    const date = new Date(today.getFullYear(), today.getMonth() + i, 1);
                    const year = date.getFullYear();
                    const month = String(date.getMonth() + 1).padStart(2, '0');
                    const monthName = date.toLocaleString('en-GB', { month: 'long' });
                    options.push({ value: `${year}-${month}`, label: `${monthName} ${year}` });
                }
                return options.sort((a, b) => a.value.localeCompare(b.value));
            }

            function preEnterSubscriptions() {
                const today = new Date();
                const currentMonth = today.getMonth() + 1;
                const currentYear = today.getFullYear();
                const subscriptionsKey = `subscriptionsAdded_${currentYear}-${currentMonth}`;

                // Check if subscriptions have already been added for this month
                if (localStorage.getItem(subscriptionsKey) === 'true') {
                    return;
                }

                // Only pre-enter subscriptions from August 2025 onwards
                if (currentYear < 2025 || (currentYear === 2025 && currentMonth < 8)) {
                    return;
                }

                const subscriptions = [
                    { what: 'Donation', where: 'The Guardian', category: 'Subscriptions', type: 'Personal', cost: 2.00 },
                    { what: 'Office 365 Basic', where: 'OneDrive', category: 'Subscriptions', type: 'Personal', cost: 1.67 },
                    { what: 'Antivirus', where: 'BitDefender', category: 'Subscriptions', type: 'Personal', cost: 3.44 },
                    { what: 'Subscription', where: 'Floatplane', category: 'Subscriptions', type: 'Personal', cost: 3.00 },
                    { what: 'Subscription', where: 'DisneyPlus', category: 'Subscriptions', type: 'Personal', cost: 3.75 },
                    { what: 'Subscription', where: 'Fitness First', category: 'Subscriptions', type: 'Personal', cost: 36.00 },
                ];

                const monthYear = `${currentYear}-${String(currentMonth).padStart(2, '0')}`;
                
                subscriptions.forEach(sub => {
                    const newExpense = {
                        id: Date.now() + Math.random(),
                        where: sub.where,
                        what: sub.what,
                        date: new Date(currentYear, currentMonth - 1, 1).toISOString(),
                        monthYear: monthYear,
                        category: sub.category,
                        type: sub.type,
                        cost: sub.cost
                    };
                    expenses.push(newExpense);
                });

                saveExpenses();
                localStorage.setItem(subscriptionsKey, 'true'); // Mark as added
            }

            // --- Event Handlers ---

            function handleLogin(event) {
                event.preventDefault();
                const password = document.getElementById('password').value;
                const messageEl = document.getElementById('loginMessage');
                if (password === CORRECT_PASSWORD) {
                    messageEl.style.display = 'none';
                    // Save login state to local storage to avoid re-logging in on reload
                    localStorage.setItem('isLoggedIn', 'true');
                    preEnterSubscriptions();
                    render();
                } else {
                    showMessage("Incorrect password. Please try again.", true, 'loginMessage');
                }
            }

            function handleFormSubmit(event) {
                event.preventDefault();
                const where = document.getElementById('where').value;
                const what = document.getElementById('what').value;
                const date = document.getElementById('date').value;
                const category = document.getElementById('category').value;
                const type = document.getElementById('type').value;
                const cost = parseFloat(document.getElementById('cost').value);

                if (isNaN(cost) || cost <= 0) {
                    showMessage("Please enter a valid positive cost.", true, 'message');
                    return;
                }

                const expenseDate = new Date(date);
                const monthYear = `${expenseDate.getFullYear()}-${String(expenseDate.getMonth() + 1).padStart(2, '0')}`;
                
                if (editingExpense) {
                    // Find the expense to edit and update it
                    const index = expenses.findIndex(exp => exp.id === editingExpense.id);
                    if (index !== -1) {
                        expenses[index] = {
                            id: editingExpense.id,
                            where, what, date, monthYear, category, type, cost
                        };
                    }
                    editingExpense = null; // Clear editing state
                    showMessage("Expense updated successfully!", false, 'message');
                } else {
                    const newExpense = {
                        id: Date.now() + Math.random(),
                        where, what, date, monthYear, category, type, cost
                    };
                    expenses.push(newExpense);
                    showMessage("Expense added successfully!", false, 'message');
                }

                saveExpenses();
                // Reset form fields
                document.getElementById('where').value = '';
                document.getElementById('what').value = '';
                document.getElementById('date').value = new Date().toISOString().split('T')[0];
                document.getElementById('category').value = '';
                document.getElementById('type').value = '';
                document.getElementById('cost').value = '';
                
                // Switch to breakdown after adding/editing
                currentView = 'breakdown';
                selectedMonthYear = monthYear;
                render();
            }

            function handleEdit(event) {
                const expenseId = parseFloat(event.currentTarget.dataset.id);
                editingExpense = expenses.find(exp => exp.id === expenseId);
                currentView = 'form';
                render();
            }

            function handleDelete(event) {
                const expenseId = parseFloat(event.currentTarget.dataset.id);
                currentDeleteId = expenseId;
                showDeleteModal();
            }

            function handleDeleteConfirmed() {
                if (currentDeleteId) {
                    expenses = expenses.filter(exp => exp.id !== currentDeleteId);
                    saveExpenses();
                    hideDeleteModal();
                    render();
                }
            }

            function showDeleteModal() {
                document.getElementById('deleteModal').classList.remove('hidden');
            }

            function hideDeleteModal() {
                document.getElementById('deleteModal').classList.add('hidden');
                currentDeleteId = null;
            }

            function downloadAsCsv() {
                const csvRows = [];
                const headers = ["Date", "Where", "What", "Category", "Type", "Cost"];
                csvRows.push(headers.join(','));

                expenses.forEach(exp => {
                    const row = [
                        `"${new Date(exp.date).toLocaleDateString('en-GB')}"`,
                        `"${exp.where.replace(/"/g, '""')}"`,
                        `"${exp.what.replace(/"/g, '""')}"`,
                        `"${exp.category.replace(/"/g, '""')}"`,
                        `"${exp.type}"`,
                        exp.cost.toFixed(2)
                    ];
                    csvRows.push(row.join(','));
                });

                const csvString = csvRows.join('\n');
                const blob = new Blob([csvString], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                if (link.download !== undefined) {
                    const url = URL.createObjectURL(blob);
                    link.setAttribute('href', url);
                    link.setAttribute('download', 'personal_expenses.csv');
                    link.style.visibility = 'hidden';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                }
            }
            
            function showMessage(msg, isError, elementId) {
                const messageEl = document.getElementById(elementId);
                if (messageEl) {
                    messageEl.textContent = msg;
                    messageEl.className = `mt-4 p-3 rounded-md text-sm ${isError ? 'bg-red-100 text-red-700' : 'bg-green-100 text-green-700'}`;
                    messageEl.style.display = 'block';
                    setTimeout(() => messageEl.style.display = 'none', 5000);
                }
            }

            // --- Initialisation ---
            if (localStorage.getItem('isLoggedIn') === 'true') {
                const today = new Date();
                selectedMonthYear = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}`;
                preEnterSubscriptions();
                render();
            } else {
                renderLogin();
            }
        });
    </script>
</body>
</html>
